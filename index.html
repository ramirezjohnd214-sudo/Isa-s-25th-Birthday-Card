<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Happy 25th Birthday, Isa!!!</title>
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500&family=Indie+Flower&display=swap" rel="stylesheet">
<style>
  :root{
    --skyTop:#08182a;        /* deep indigo */
    --skyBottom:#0c2743;     /* lighter indigo */
    --glow:#ffffffd0;
    --accent:#7dd3fc;
    --grass:#0e1b22;
    --ui:#0b1220cc;
    --gold:#ffd166;
    --danger:#ff6b6b;
  }
  html,body{height:100%;margin:0;background:linear-gradient(to bottom,var(--skyTop),var(--skyBottom));color:#e6f1ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;overflow:hidden}
  /* BACKGROUND ART */
  /* Full-bleed blurred fill */
.bg-fill{
  position:fixed; inset:0; z-index:1; pointer-events:none;
  width:100%; height:100%;
  object-fit:cover;       /* fills the screen */
  filter: blur(24px) brightness(.75) saturate(1.1);
  transform: scale(1.05); /* hide blur edges */
}

/* Crisp full artwork on top, uncropped */
.bg-img{
  position:fixed; inset:0; z-index:1; pointer-events:none;
  width:100%; height:100%;
  object-fit:contain;     /* shows the entire 1536x1024 image */
  image-rendering:auto;
}
  /* CANVAS STARS */
  #star-canvas{position:fixed;inset:0;z-index:0;pointer-events:none;}
  /* INTERACTIVE STAR LAYER (DOM) */
  #message-layer{position:fixed;inset:0;z-index:2;pointer-events:none;}
  /* Add this keyframes block (anywhere in <style>) */
@keyframes twinklePulse {
  0%   { transform: scale(1);   box-shadow: 0 0 10px 2px #ffffffd0, 0 0 2px 1px #fff; opacity: 0.9; }
  50% { transform: scale(1.3);
      box-shadow: 0 0 25px 7px #ffffffee, 0 0 4px 2px #fff;
      opacity: 1; }
  100% { transform: scale(1);   box-shadow: 0 0 10px 2px #ffffffd0, 0 0 2px 1px #fff; opacity: 0.9; }
}
@keyframes sparkleBurst {
  0% { transform: scale(0); opacity: 0.8; box-shadow: 0 0 10px 4px #fff; }
  50% { transform: scale(2.5); opacity: 1; box-shadow: 0 0 20px 8px #fff, 0 0 40px 12px #ffd700; }
  100% { transform: scale(0); opacity: 0; box-shadow: none; }
}
.sparkle {
  position: absolute;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #fff;
  pointer-events: none;
  animation: sparkleBurst 0.9s ease-out forwards;
}
/* Update your .mstar rules */
.mstar{
  position:absolute; width:8px; height:8px; border-radius:50%;
  background:#fff; cursor:pointer; pointer-events:auto;
  /* existing glow (keep): */
  box-shadow:0 0 10px 2px var(--glow), 0 0 2px 1px #fff;

  /* smooth hover still works */
  transition:transform .12s;

  /* NEW: twinkle animation (duration customizable via CSS var) */
  animation: twinklePulse var(--dur, 2.8s) ease-in-out infinite;
}

/* Keep your hover behavior */
.mstar:hover{ transform: scale(1.5); }
.tooltip {
  position: absolute;
  transform: translate(-50%, -160%);
  padding: 0.35rem 0.6rem;
  background: rgba(0, 0, 0, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.35);
  border-radius: 6px;
  color: #fff;
  font-size: 0.75rem;
  font-family: "Quicksand", sans-serif;
  white-space: nowrap;
  pointer-events: none;
  backdrop-filter: blur(4px);
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.25s ease, transform 0.25s ease;
}
@keyframes tooltipGlow {
  0% {
    box-shadow: 0 0 6px rgba(255, 255, 255, 0.4),
                0 0 12px rgba(125, 211, 252, 0.2);
  }
  50% {
    box-shadow: 0 0 14px rgba(255, 255, 255, 0.8),
                0 0 28px rgba(125, 211, 252, 0.6),
                0 0 45px rgba(255, 255, 255, 0.3);
  }
  100% {
    box-shadow: 0 0 6px rgba(255, 255, 255, 0.4),
                0 0 12px rgba(125, 211, 252, 0.2);
  }
}

/* add glow effect when hovering on star */
.mstar:hover .tooltip {
  opacity: 1;
  visibility: visible;
  transform: translate(-50%, -180%);
  animation: tooltipGlow 2.5s ease-in-out infinite;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translate(-50%, -150%) scale(0.9); }
  to { opacity: 1; transform: translate(-50%, -160%) scale(1); }
}
  /* UI BAR */
  /* Smaller, floating HUD in the top-right */
.hud {
  position:fixed;
  top:1rem;
  right:1rem;
  z-index:5;

  background:var(--ui);
  border:1px solid #ffffff24;
  backdrop-filter:blur(6px);

  border-radius:12px;
  padding:.6rem .8rem;

  display:flex;
  flex-direction:column;
  gap:.5rem;

  max-width:220px;
  width:max-content;
}

/* Title smaller, no huge bar */
.hud-title {
  font-size:.9rem;
  font-weight:600;
  color:#e6f1ff;
  margin:0;
  line-height:1.2;
  text-wrap:balance;
}

/* Stack buttons vertically on mobile */
.hud-buttons {
  display:flex;
  flex-wrap:wrap;
  gap:.5rem;
}

.hud-buttons button {
  flex:1 1 auto;
  white-space:nowrap;
  font-size:.8rem;
  line-height:1.2;
  padding:.5rem .6rem;
  border-radius:10px;
}

/* Remove pills since we're not showing message count anymore */
.pill { display:none!important; }

/* Remove giant CTA at the bottom if you want the bottom bar gone too */
.cta { display:none!important; }

@media (min-width:600px){
  .hud {
    max-width:none;
    width:auto;
  }
  .hud-buttons {
    flex-wrap:nowrap;
  }
  .hud-buttons button {
    flex:0 0 auto;
  }
}
  button, .btn{
    background:#111933; color:#e6f1ff; border:1px solid #ffffff28; border-radius:10px; padding:.5rem .75rem; font-weight:600; cursor:pointer;
  }
  button:hover{filter:brightness(1.2)}
  .ghost{background:transparent}
  .accent{border-color:#7dd3fc50}
  .danger{border-color:#ff6b6b70;color:#ffb3b3}
  /* FOOTER CTA */
  .cta{
    position:fixed; left:50%; bottom:1rem; transform:translateX(-50%);
    z-index:3; display:flex; gap:.5rem; align-items:center; background:var(--ui);
    border:1px solid #ffffff24; padding:.6rem .8rem; border-radius:12px; backdrop-filter:blur(6px)
  }
  /* MODALS */
  dialog{border:none; border-radius:16px; background:#0b1220f2; color:#e6f1ff; padding:1.25rem; width:min(520px,92vw)}
  dialog::backdrop{background:rgba(0,0,0,.5)}
  .field{display:grid; gap:.35rem; margin:.6rem 0}
  input[type="text"], input[type="email"], input[type="password"], textarea{
    width:100%; background:#0f1830; color:#e6f1ff; border:1px solid #ffffff24; border-radius:10px; padding:.55rem .7rem;
  }
  textarea{min-height:100px; resize:vertical}
  .row{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap}
  .muted{opacity:.7;font-size:.9rem}
  .pill{padding:.2rem .5rem; border:1px solid #ffffff28; border-radius:999px; font-size:.75rem}
  .admin{color:#b4f5c6; border-color:#b4f5c680}
  .notice{position:fixed; left:50%; top:calc(1rem + 58px); transform:translateX(-50%); z-index:5; background:#101b33; border:1px solid #ffffff24; padding:.5rem .8rem; border-radius:10px; display:none}
  @media (max-width:700px){ .hud{gap:.35rem} .cta{left:50%; transform:translateX(-50%);}}
  
.hud {
  left:auto;
  right:1rem;
  max-width:220px;
  width:auto;
  display:flex;
  flex-direction:column;
}
.hud.compact {
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 5;
  background: rgba(0,0,0,0.4);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 12px;
  padding: .8rem;
  backdrop-filter: blur(6px);
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: .4rem;
  width: fit-content;
}

.hud.compact h1 {
  font-size: 0.9rem;
  font-weight: 600;
  margin: 0 0 .2rem 0;
  color: #fff;
}

.hud.compact button {
  font-size: 0.8rem;
  padding: 0.4rem 0.6rem;
  border-radius: 8px;
}
.hud.compact {
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 10;
  background: rgba(15, 20, 40, 0.7);
  border: 1px solid rgba(255, 255, 255, 0.35);
  border-radius: 12px;
  padding: 0.8rem 1rem;
  backdrop-filter: blur(12px);
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 0.5rem;
  color: #fff;
  box-shadow: 0 0 18px rgba(0, 0, 0, 0.6);
  transition: opacity 0.3s ease;
}

.hud.compact h1 {
  font-size: 1rem;
  font-weight: 600;
  color: #fff;
  margin: 0;
}
.hud.compact button {
  background: rgba(255, 255, 255, 0.15);
  color: #fff;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  font-size: 0.9rem;
  padding: 0.5rem 0.8rem;
  cursor: pointer;
  transition: background 0.2s ease, transform 0.1s ease;
}

.hud.compact button:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.05);
}
.message-modal {
  border: none;
  border-radius: 12px;
  padding: 1.5rem;
  max-width: 400px;
  background: rgba(0, 0, 0, 0.85);
  color: #fff;
  backdrop-filter: blur(10px);
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
  animation: fadeIn 0.3s ease;
}
/* --- Fun message modal styling --- */
.message-modal {
  border: none;
  border-radius: 16px;
  padding: 1.8rem;
  max-width: 420px;
  background: rgba(15, 20, 40, 0.85);
  color: #fff;
  backdrop-filter: blur(10px);
  box-shadow: 0 0 25px rgba(255, 255, 255, 0.3), 0 0 60px rgba(0, 150, 255, 0.1);
  font-family: "Indie Flower", cursive;
  text-align: center;
  animation: popIn 0.4s ease-out;
  transform-origin: center;
}
.message-modal h2 {
  font-size: 1.8rem;
  color: #ffda79;
  margin-bottom: 0.6rem;
  text-shadow: 0 0 10px rgba(255, 255, 200, 0.8);
}
.message-modal p {
  font-size: 1.2rem;
  line-height: 1.5;
  white-space: pre-wrap;
}
/* --- Sparkle pop-in animation for message modal --- */
@keyframes sparklePop {
  0% {
    opacity: 0;
    transform: scale(0.8) rotate(-2deg);
    box-shadow: 0 0 0px rgba(255,255,255,0);
  }
  40% {
    opacity: 1;
    transform: scale(1.05) rotate(1deg);
    box-shadow:
      0 0 20px rgba(255,255,255,0.7),
      0 0 40px rgba(255,215,0,0.4),
      0 0 60px rgba(125,211,252,0.3);
  }
  100% {
    opacity: 1;
    transform: scale(1) rotate(0);
    box-shadow:
      0 0 12px rgba(255,255,255,0.4),
      0 0 25px rgba(125,211,252,0.2);
  }
}

.message-modal {
  animation: sparklePop 0.8s ease-out;
  transition: transform 0.3s ease, box-shadow 0.5s ease;
}
/* Soft "pop-in" animation */
@keyframes popIn {
  from {
    transform: scale(0.8);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}
/* --- Add Your Star button glow animation --- */
/* FORCE glowing Add Your Star button */
@keyframes pulseGlow {
  0% {
    box-shadow: 0 0 6px rgba(255, 255, 255, 0.4),
                0 0 12px rgba(255, 255, 255, 0.3),
                0 0 0px rgba(125, 211, 252, 0);
    transform: scale(1);
  }
  50% {
    box-shadow: 0 0 12px rgba(255, 255, 255, 0.8),
                0 0 25px rgba(125, 211, 252, 0.8),
                0 0 40px rgba(125, 211, 252, 0.4);
    transform: scale(1.08);
  }
  100% {
    box-shadow: 0 0 6px rgba(255, 255, 255, 0.4),
                0 0 12px rgba(255, 255, 255, 0.3),
                0 0 0px rgba(125, 211, 252, 0);
    transform: scale(1);
  }
}
#addBtn {
  position: relative;
  z-index: 1000;
  animation: pulseGlow 2.8s ease-in-out infinite !important;
  transition: transform 0.2s, filter 0.3s;
}
#addBtn:hover {
  transform: scale(1.12);
  filter: brightness(1.3);
}
/* --- Shooting Star Animation --- */
/* --- Shooting Star Animation (fixed visibility) --- */
@keyframes shootingStar {
  0% {
    transform: translate(0, 0) scale(1);
    opacity: 1;
  }
  100% {
    transform: translate(-2000px, 800px) scale(0.8);
    opacity: 0;
  }
}

.shooting-star {
  position: fixed;
  width: 3px;
  height: 3px;
  background: white;
box-shadow: 0 0 25px 8px rgba(255,255,255,0.95),
            0 0 80px 20px rgba(255,255,255,0.7);

  border-radius: 50%;
  z-index: 9999; /* ensure it's above all layers */
  opacity: 0;
  animation: shootingStar 1.4s linear forwards;
  pointer-events: none;
}
.firework {
  position: absolute;
  width: 4px;
  height: 4px;
  background: white;
  border-radius: 50%;
  animation: shoot 1s ease-out forwards;
  pointer-events: none;
  z-index: 0;
}

@keyframes shoot {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  70% { opacity: 1; }
  100% { transform: translateY(-400px) scale(0.8); opacity: 0; }
}

.explosion {
  position: absolute;
  width: 2px;
  height: 2px;
  border-radius: 50%;
  pointer-events: none;
  animation: explode 1.5s ease-out forwards;
}

@keyframes explode {
  0% { transform: scale(1); opacity: 1; }
  100% { transform: scale(1.2) translate(var(--x), var(--y)); opacity: 0; }
}
</style>
</head>
<body>
  <canvas id="star-canvas" aria-hidden="true"></canvas>
  <img class="bg-fill" src="IsaBday.png" alt="" aria-hidden="true" loading="eager" />
  <img class="bg-img"  src="IsaBday.png" alt="" aria-hidden="true" loading="eager" />

  <div id="message-layer"></div>

  <div class="hud compact" role="toolbar">
  <h1>✨ Add your star for Isa</h1>
  <button id="addBtn" class="accent">Add Your Star ✨</button>
  <button id="loginBtn" class="ghost">Admin</button>
  <button id="logoutBtn" class="ghost" style="display:none">Sign out</button>
</div>

  <div class="cta">
    <span class="muted">Tip: click the sky to place your star</span>
  </div>

  <!-- Add Star Modal -->
  <dialog id="addModal">
    <form id="addForm" method="dialog">
      <h3>Add your star ✨</h3>
      <p class="muted">You clicked at: <span id="coordsText">x0,y0</span>. Enter your name & message.</p>
      <div class="field">
        <label>Name</label>
        <input id="nameInput" maxlength="40" required placeholder="Your name">
      </div>
      <div class="field">
        <label>Message</label>
        <textarea id="msgInput" maxlength="300" required placeholder="Write a sweet note…"></textarea>
      </div>
      <div class="row">
        <button type="submit" class="accent">Save Star</button>
        <button type="button" id="cancelAdd" class="ghost">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- View/Edit Modal -->
  <dialog id="viewModal" class="message-modal">
  <div id="viewContent"></div>
  <div class="row" style="margin-top:.75rem">
    <button id="closeView" class="ghost">Close</button>
    <div class="spacer"></div>
    <button id="editBtn" class="ghost" style="display:none">Edit</button>
    <button id="deleteBtn" class="danger" style="display:none">Delete</button>
  </div>
</dialog>

  <!-- Edit Modal -->
  <dialog id="editModal">
    <form id="editForm" method="dialog">
      <h3>Edit message</h3>
      <div class="field">
        <label>Name</label>
        <input id="editName" maxlength="40" required>
      </div>
      <div class="field">
        <label>Message</label>
        <textarea id="editMsg" maxlength="300" required></textarea>
      </div>
      <div class="row">
        <button type="submit" class="accent">Save</button>
        <button type="button" id="cancelEdit" class="ghost">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- Admin Login -->
  <dialog id="adminModal">
    <form id="adminForm" method="dialog">
      <h3>Admin sign in</h3>
      <p class="muted">Admins can edit or delete stars and export/import.</p>
      <div class="field">
        <label>Email</label>
        <input id="adminEmail" type="email" placeholder="admin@example.com" required>
      </div>
      <div class="field">
        <label>Password</label>
        <input id="adminPass" type="password" required value="isasings111">
      </div>
      <div class="row">
        <button type="submit" class="accent">Sign in</button>
        <button type="button" id="cancelAdmin" class="ghost">Cancel</button>
      </div>
      <div class="row" style="margin-top:.5rem; gap:.4rem">
        <button type="button" id="exportBtn" class="ghost" style="display:none">Export JSON</button>
        <label class="btn ghost" style="display:none" id="importLabel">Import JSON<input id="importFile" type="file" accept="application/json" hidden></label>
      </div>
    </form>
  </dialog>

  <div id="notice" class="notice" role="status"></div>

  <!-- Firebase (modular v10) -->
  <script type="module">
    /* ========== Decorative starfield (5000) ========== */
    const canvas = document.getElementById('star-canvas');
    const ctx = canvas.getContext('2d', { alpha: true });
    let W=innerWidth, H=innerHeight; canvas.width=W; canvas.height=H;
    const N = 5000;
    const stars = Array.from({length:N}, () => ({
      x: Math.random()*W,
      y: Math.random()*H*0.9,                    // leave a touch of room for UI
      r: Math.random()*1.1 + 0.2,
      tw: Math.random()*Math.PI*2,
      sp: 0.002 + Math.random()*0.004
    }));
    function draw(){
      ctx.clearRect(0,0,W,H);
      for(const s of stars){
        s.tw += s.sp;
        const a = 0.25 + 0.75*(0.5+0.5*Math.sin(s.tw));
        ctx.globalAlpha = a;
        ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
        ctx.fillStyle='#ffffff'; ctx.fill();
      }
      requestAnimationFrame(draw);
    }
    addEventListener('resize', ()=>{W=innerWidth; H=innerHeight; canvas.width=W; canvas.height=H;});
    draw();

    /* ========== Firebase (Firestore + Auth) ========== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // TODO: Firebase config here (Project settings → Web app)
    const firebaseConfig = {
      apiKey: "AIzaSyADhhtFZZcRMOwqU_dwR7RMHITYsfvXDUY",
  authDomain: "isa-s-25th-birthday.firebaseapp.com",
  projectId: "isa-s-25th-birthday",
  storageBucket: "isa-s-25th-birthday.firebasestorage.app",
  messagingSenderId: "590841309751",
  appId: "1:590841309751:web:bb444deda0263f1b9fedb2"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    // Everyone auto-joins anonymously (so rules can require auth even for creates)
    signInAnonymously(auth).catch(console.error);

    /* ========== Message stars layer ========== */
    const layer = document.getElementById('message-layer');
    const addBtn = document.getElementById('addBtn');
    const countBadge = document.getElementById('count');
    const addModal = document.getElementById('addModal');
    const adminModal = document.getElementById('adminModal');
    const viewModal = document.getElementById('viewModal');
    const editModal = document.getElementById('editModal');
    const adminEmailInput = document.getElementById('adminEmail');
    const adminPassInput = document.getElementById('adminPass');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importLabel = document.getElementById('importLabel');
    const importFile = document.getElementById('importFile');
    const notice = document.getElementById('notice');

    let admin = false;
    let currentDocId = null;

    function toast(text, ms=2000){
      notice.textContent = text; notice.style.display='block';
      setTimeout(()=>notice.style.display='none', ms);
    }

    // Convert px -> percent (so layout is responsive across screens)
    function toPct(x,y){ return { px: x, py: y, x: (x/innerWidth), y: (y/innerHeight) }; }
    function fromPct(x,y){ return { x: x*innerWidth, y: y*innerHeight }; }

    // Capture click for placing a new star
    let pendingPos = null;
    addBtn.addEventListener('click', ()=>{
      document.body.style.cursor='crosshair';
      toast('Click anywhere in the sky to place your star…', 2500);
      const clickOnce = (ev)=>{
        document.removeEventListener('click', clickOnce);
        document.body.style.cursor='default';
        const {clientX, clientY} = ev;
        pendingPos = toPct(clientX, clientY);
        // avoid clicks on UI bars (top ~110px) / grass (bottom ~140px of most images)
        if(clientY < 90 || clientY > innerHeight-140){ toast('Try a bit higher in the sky ✨', 2000); pendingPos=null; return;}
        document.getElementById('coordsText').textContent = `(${Math.round(pendingPos.x*100)}%, ${Math.round(pendingPos.y*100)}%)`;
        addModal.showModal();
      };
      setTimeout(()=>document.addEventListener('click', clickOnce), 0);
    });
    document.getElementById('cancelAdd').onclick = ()=>addModal.close();
function sparkleAt(x, y) {
  const sparkle = document.createElement('div');
  sparkle.className = 'sparkle';
  sparkle.style.left = `${x}px`;
  sparkle.style.top = `${y}px`;
  sparkle.style.position = 'fixed';
  document.body.appendChild(sparkle);
  setTimeout(() => sparkle.remove(), 900);
}
    // Add star to Firestore
    document.getElementById('addForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!pendingPos){ addModal.close(); return;}

  const name = document.getElementById('nameInput').value.trim();
  const message = document.getElementById('msgInput').value.trim();

  await addDoc(collection(db, 'messages'), {
    name,
    message,
    x: pendingPos.x,
    y: pendingPos.y,
    createdAt: serverTimestamp()
  });

  // sparkle where the star goes
  const px = fromPct(pendingPos.x, pendingPos.y);
  sparkleAt(px.x, px.y);

  addModal.close();
  toast('Your star is live ⭐');
});

    // Render a message star
    function renderStar(id, data){
  // create element if missing
  let el = document.querySelector(`.mstar[data-id="${id}"]`);
  if(!el){
    el = document.createElement('div');
    el.className='mstar';
    el.dataset.id = id;

    // give each star a unique twinkle speed and start time
    el.style.setProperty('--dur', `${(2 + Math.random()*2).toFixed(2)}s`);
    el.style.animationDelay = `${(Math.random()*2).toFixed(2)}s`;

    const tip = document.createElement('div');
    tip.className='tooltip';
    tip.textContent = data.name;
    el.appendChild(tip);

    // hover tooltip
   el.addEventListener('mouseenter', () => {
  tip.style.visibility = 'visible';
  tip.style.opacity = '1';
});

el.addEventListener('mouseleave', () => {
  tip.style.visibility = 'hidden';
  tip.style.opacity = '0';
});
    // click to open message (with guard)
    el.addEventListener('click', (e) => {
      e.stopPropagation();          // don't let click bubble
      if (viewModal.open) return;   // if already open, don't open again
      openView(id, data);
    });

    layer.appendChild(el);
  }

  // move existing star to correct spot
  const pos = fromPct(data.x, data.y);
  el.style.left = `${pos.x}px`;
  el.style.top  = `${pos.y}px`;
}
    function removeStar(id){
      const el = document.querySelector(`.mstar[data-id="${id}"]`);
      if(el) el.remove();
    }

    // Live subscription
    const q = query(collection(db,'messages'), orderBy('createdAt','asc'));
onSnapshot(q, snap=>{
  if (countBadge) {
    countBadge.textContent = `${snap.size} messages`;
  }

  const liveIds = new Set();
  snap.forEach(docu=>{
    const id = docu.id;
    const data = docu.data();
    liveIds.add(id);
    renderStar(id, data);
  });

  document.querySelectorAll('.mstar').forEach(el=>{
    if(!liveIds.has(el.dataset.id)) el.remove();
  });
});

    /* ----- View / Edit / Delete ----- */
    const viewContent = document.getElementById('viewContent');
    document.getElementById('closeView').onclick = ()=>viewModal.close();

  function openView(id, data){
  currentDocId = id;
  viewContent.innerHTML = `
    <h3>${escapeHtml(data.name)}</h3>
    <p style="white-space:pre-wrap">${escapeHtml(data.message)}</p>
  `;
  document.getElementById('editBtn').style.display = admin ? 'inline-block' : 'none';
  document.getElementById('deleteBtn').style.display = admin ? 'inline-block' : 'none';
  viewModal.showModal();

  // ✨ Sparkle burst when the message opens
  const rect = viewModal.getBoundingClientRect();
  const cx = rect.left + rect.width / 2;
  const cy = rect.top + rect.height / 2;
  sparkleBurst(cx, cy);
}
function sparkleBurst(x, y, count = 12) {
  for (let i = 0; i < count; i++) {
    const s = document.createElement("div");
    s.className = "sparkle";
    s.style.left = `${x + (Math.random() * 100 - 50)}px`;
    s.style.top = `${y + (Math.random() * 60 - 30)}px`;
    document.body.appendChild(s);
    setTimeout(() => s.remove(), 900);
  }
}
    document.getElementById('deleteBtn').onclick = async () => {
  if (!admin || !currentDocId) return;
  if (!confirm('Delete this star?')) return;

  try {
    await deleteDoc(doc(db, 'messages', currentDocId));
    viewModal.close();
    toast('Star deleted');
  } catch (err) {
    alert('Delete failed:\n' + (err?.message || err));
    console.error('Delete error:', err);
  }
};
    const editForm = document.getElementById('editForm');
    document.getElementById('editBtn').onclick = ()=>{
      const starEl = document.querySelector(`.mstar[data-id="${currentDocId}"]`);
      if(!starEl) return;
      // grab existing data from view
      const name = viewContent.querySelector('h3').textContent;
      const message = viewContent.querySelector('p').textContent;
      document.getElementById('editName').value = name;
      document.getElementById('editMsg').value = message;
      viewModal.close(); editModal.showModal();
    };
    document.getElementById('cancelEdit').onclick = ()=>editModal.close();
    editForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!admin || !currentDocId) return;
      await updateDoc(doc(db,'messages', currentDocId), {
        name: document.getElementById('editName').value.trim(),
        message: document.getElementById('editMsg').value.trim()
      });
      editModal.close(); toast('Updated ⭐');
    });

    /* ----- Admin sign-in / sign-out ----- */
    loginBtn.onclick = ()=>adminModal.showModal();
    document.getElementById('cancelAdmin').onclick = ()=>adminModal.close();
    document.getElementById('logoutBtn').onclick = ()=>signOut(auth);

    document.getElementById('adminForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = adminEmailInput.value.trim();
      const pass  = adminPassInput.value;
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        adminModal.close(); toast('Signed in as admin');
      }catch(err){
        alert('Sign-in failed: ' + err.message);
      }
    });

    onAuthStateChanged(auth, (user)=>{
      admin = !!(user && user.email); // email/password login → admin by rules
      document.querySelector('.hud').classList.toggle('admin', admin);
      loginBtn.style.display  = admin ? 'none' : 'inline-block';
      logoutBtn.style.display = admin ? 'inline-block' : 'none';
      exportBtn.style.display = admin ? 'inline-block' : 'none';
      importLabel.style.display = admin ? 'inline-flex' : 'none';
    });

    /* ----- Export / Import (admin) ----- */
    // ----- Export all stars (Admin only) -----
exportBtn.onclick = async () => {
  try {
    const { getDocs } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
    const snap = await getDocs(collection(db, "messages"));
    const data = [];
    snap.forEach(docu => data.push({ id: docu.id, ...docu.data() }));

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "isa-stars.json";
    a.click();
    toast("Export complete!");
  } catch (err) {
    alert("Export failed: " + err.message);
  }
};
    importFile.onchange = async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const text = await file.text();
      const arr = JSON.parse(text);
      for(const row of arr){
        // if id exists update, else add
        const ref = row.id ? doc(db,'messages',row.id) : null;
        if(ref){ await updateDoc(ref, row); } else { await addDoc(collection(db,'messages'), row); }
      }
      toast('Import complete');
    };

    function escapeHtml(str){ return str.replace(/[&<>"']/g,s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[s])) }
  // --- Shooting star effect every 30 seconds ---
// --- Randomized Shooting Star Effect ---
function spawnShootingStar() {
  const star = document.createElement('div');
  star.className = 'shooting-star';

  // Randomly decide direction (true = left→right, false = right→left)
  const leftToRight = Math.random() > 0.5;

  const startX = leftToRight ? -200 : innerWidth + 200;
  const startY = Math.random() * (innerHeight * 0.5); // top half of screen
  const endX = leftToRight ? innerWidth + 400 : -400;
  const endY = startY + (Math.random() * 400 - 200); // small angle variation

  const dx = endX - startX;
  const dy = endY - startY;

  star.style.left = `${startX}px`;
  star.style.top = `${startY}px`;
  star.style.transform = `rotate(${Math.atan2(dy, dx)}rad)`;

  document.body.appendChild(star);

  // Animate movement using CSS transition
  star.animate(
    [
      { transform: `translate(0, 0) scale(1)`, opacity: 1 },
      { transform: `translate(${dx}px, ${dy}px) scale(0.8)`, opacity: 0 }
    ],
    { duration: 1500, easing: 'linear' }
  );

  setTimeout(() => star.remove(), 1500);
}

// Spawn every 30 seconds (randomize slightly so it's not robotic)
setInterval(() => {
  if (Math.random() < 0.9) spawnShootingStar(); // 90% chance each cycle
}, 30000);

// Start one right away
spawnShootingStar();
  </script>
  function createFirework() {
  const fw = document.createElement("div");
  fw.className = "firework";
  fw.style.left = Math.random() * window.innerWidth + "px";
  fw.style.bottom = "0px";
  document.body.appendChild(fw);

  // when shoot ends, create explosion
  fw.addEventListener("animationend", () => {
    fw.remove();
    createExplosion(parseInt(fw.style.left), window.innerHeight - 400);
  });
}

function createExplosion(x, y) {
  const colors = ["#ffd700", "#ff69b4", "#87cefa", "#ffffff", "#ffa500"];
  for (let i = 0; i < 25; i++) {
    const spark = document.createElement("div");
    spark.className = "explosion";
    spark.style.left = x + "px";
    spark.style.top = y + "px";
    spark.style.background = colors[Math.floor(Math.random() * colors.length)];
    spark.style.setProperty("--x", `${(Math.random() - 0.5) * 300}px`);
    spark.style.setProperty("--y", `${(Math.random() - 0.5) * 300}px`);
    document.body.appendChild(spark);
    setTimeout(() => spark.remove(), 1500);
  }
}

// Launch fireworks randomly every 20–30 seconds
setInterval(() => {
  const chance = Math.random();
  if (chance < 0.8) createFirework();
}, 25000);
</body>
</html>